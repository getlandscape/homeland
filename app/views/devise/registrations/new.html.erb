<% title_tag t("users.register_user") %>
<%
auth_session = session[:omniauth] || {}
auth_info = auth_session["info"] || {}
if auth_info
  resource.omniauth_provider = auth_session["provider"]
  resource.omniauth_uid = auth_session["uid"]

  resource.email = auth_info["email"] if resource.email.blank?
  resource.name = auth_info["name"] if resource.name.blank?
  if resource.login.blank?
    resource.login = auth_info["login"] || auth_info["name"]
  end
end
%>
<div class="row">
  <div class="col"></div>
  <div class="col-lg-6">
    <div class="card card-lg">
      <div class="card-body">
        <div class="card-title">
          <%= t("users.register_user") %>
          <div class="actions hide-ios">
            <%= link_to t("common.login"), new_session_path(resource_name) %>
          </div>
        </div>
        <% if auth_info.present? %>
          <div class="alert">
            <h4 class="alert-heading"><%= t("users.complete_your_info") %></h4>
            <p><%= t("users.binding_via_html", provider: Homeland::Utils.omniauth_name(resource.omniauth_provider)) %></p>
            <p><%= t("users.binding_has_account_html") %></p>
          </div>
        <% end %>
        <%= form_for resource, as: resource_name, url: registration_path(resource_name) do |f| %>

          <% if params[:wallet_type].present? && params[:wallet_type].in?(User::SUPPORTED_WALLET_TYPES)%>
            <%= render partial: 'decentralized_sign_up_form' , locals: { f: f, resource: resource } %>
          <% else %>
            <%= render partial: 'normal_sign_up_form' , locals: { f: f, resource: resource, auth_info: auth_info } %>
          <% end %>

          <%= form_group(f, :base, label: false) do %>
            <div class="input-group input-group-lg">
              <%= render "/shared/captcha_input" %>
            </div>
          <% end %>

          <div class="form-actions">
            <%= f.submit t('users.submit_new_user'), class: "btn btn-lg btn-primary", 'data-disable-with' => t("common.submitting") %>
          </div>
        <% end %>

        <% if params[:wallet_type].blank?   %>
          <div class='button_wrapper' class="search_row">
            <div class='dc_button'>
              <a href='#' class='eth_connect' >
                <%= image_pack_tag('metamask.png', style: 'width: 24px; height: 24px') %>
                MetaMask
              </a>
            </div>
            <div class='dc_button'>
              <a href='#' class='polka_connect' >
                <%= image_pack_tag('polka.png', style: 'width: 24px; height: 24px') %>
                Polka Dot
              </a>
            </div>
          </div>
        <% end %>

      </div>
    </div>
  </div>
  <div class="col"></div>
</div>
<style>
.button_wrapper{
  text-align: center;
  margin: 24px auto 0 auto;
  width: 300px;
}

.dc_button{
  border: 1px solid #D1D5DB;
  float: left;
  margin-left: 10px;
  filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.08));
  border-radius: 4px;
  height:36px;
  width: 120px;

  display: flex;
  justify-content: center;
  align-items: center;
}

.dc_button a {
  color: #111111;
}

</style>

<script>
if (typeof window.ethereum !== 'undefined') {
  document.querySelector('a.eth_connect').addEventListener('click', async () => {
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });

		console.info("=== accounts: ", accounts)
    location.href="?address=" + accounts[0] + "&wallet_type=eth"
  });
}else {
  alert('You have not installed a wallet(e.g. Metamask) yet, please go to install it')
}

document.querySelector('a.polka_connect').addEventListener('click', async () => {
  const extensions = await polka.web3Enable(window.location.hostname);

  if (!extensions.length) {
    throw new Error('Polkadot extension not found, please go to install it: https://polkadot.js.org/extension/');
  }

  const accounts = await polka.web3Accounts();
  console.info("=== accounts: ", accounts)
  location.href="?address=" + accounts[0].address + "&wallet_type=polka"
});
</script>
